<!doctype html>
<html>
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <title>TODO App</title>

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="/css/bootstrap.min.css">

        <!-- Font Awesome -->
        <link rel="stylesheet"  href="/css/font-awesome.min.css">

        <!-- JQuery -->
        <script src="/js/jquery.min.js"></script>

        <!-- Latest compiled and minified JavaScript -->
        <script src="/js/bootstrap.min.js"></script>

        <!-- Vue.js -->
        <!-- script src="https://cdn.jsdelivr.net/npm/vue-template-compiler"></script -->
        <script src="/js/vue.js"></script>
        
    </head>
    <body>
        <style>
            .status-checked {
                text-decoration: line-through;
            }
        </style>
            
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div id="databinding">
                    <h2>Shopping List</h2>
                    <ul class="list-group" id="listgroup" droppable=true v-on:dragover="dragover"  v-on:drop="drop">
                            <li class="list-group-item" v-for="item in shoppingItems" :id="getItemId(item.id)" :key="item.id" draggable="true" v-on:dragstart="dragstart"  v-on:dragover="dragover" v-on:dragenter="dragenter" v-on:dragend="dragend">
                                <span v-on:click="toggleStatus(item.id)" v-bind:class="{'status-checked': isClosed(item) }">{{ item.title }}</span>
                            <span class="pull-right">
                                <button class="btn btn-xs btn-danger" v-on:click="deleteItem(item.id)">
                                    <i class="fa fa-trash-o" aria-hidden="true"></i>
                                </button>
                            </span>
                        </li>
                        <li class="list-group-item" id="placeholder">placeholder</li>
                            
                    </ul>
                    <div class="input-group">
                        <input type="text" 
                            class="form-control" 
                            placeholder="New Item" v-on:keyup.enter="addItem"
                            v-model="newItem.title">
                        <span class="input-group-btn">event.preventDefault()
                            <button class="btn btn-primary" type="button" v-on:click="addItem">Create</button>
                        </span>
                    </div><!-- /input-group -->
                    </div>
                </div>
            </div>
        </div>
        <script>
/*            function drop(event) {
                console.log("DROP OUTSIDE")
                event.preventDefault()
            }
            */
            // this function returns an object that is suitable to be put in the 
            // fetch api as options
            function httpOptions(m, obj) {
                // this object will be returned
                options = {
                    method: m !== undefined ? m : "GET",
                    mode: "cors",
                    cache: "no-cache",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    redirect: "follow",
                }
                if (obj !== undefined) {
                    options.body = JSON.stringify(obj)
                }
                return options
            }

            // development mode, must be removed in prod
            Vue.config.devtools = true

            // here we initialize the vue object
            var app = new Vue({
                // everything from this element downwards is treated as vue template
                el: '#databinding',
                // this defines the data on whiche vue listens
                data() {
                    return {
                        shoppingItems: [],
                        newItem: {},
                        dragElement: null,
                        _dragNode: null,
                        insertIndex: null,
                        placeholder: document.getElementById('placeholder')
                    }
                },
                // this happens on load of the page
                created: function() {
                    this.loadAll()
                    this.reorder()
                },
                // define the methods
                methods: {
                    // load all items
                    loadAll: function() {
                        fetch('/items', httpOptions())
                            .then((res)  => res.json())
                            .then((json) => {
                                this.shoppingItems = json.items ? json.items : []
                            })
                            .catch((err) => console.error(err))
                    },

                    // create an item
                    addItem: function() {
                        // if title is empty we do not do anything
                        if (!$.trim(this.newItem.title)) {
                            this.newItem = {}
                            return
                        }
                        // add item status and ordering
                        this.newItem.status = "OPEN"
                        // TODO: orderno must be the last of the shopping list plus 1
                        this.newItem.orderno = 0

                        // now send it to backend
                        fetch('/items', httpOptions("POST", this.newItem))
                        .then((res)  => res.json())
                        .then((json) => {
                            // send successful, add the item to vue data array so it reflects on the page
                            this.newItem.id = json.id
                            this.shoppingItems.push(this.newItem)
                            // this is not needed any more
                            this.newItem = {}
                        })
                        .catch((err) => console.error(err))
                    },

                    // delete an item
                    deleteItem: function(id) {
                        // get the position of the item in the array:
                        let index = this.shoppingItems.findIndex(x => x.id == id)
                        // send te delete request to backend, if successful remove the item from vue data array
                        fetch('/items/' + id, httpOptions("DELETE"))
                        .then((res) => this.shoppingItems.splice(index, 1))
                        .catch((err) =>  console.log(error))
                    },
                    // update status
                    toggleStatus: function(id) {
                        // get a reference to the item with this id
                        let item = this.shoppingItems.find(x => x.id === id)
                        // copy the item by value ("clone")
                        let toChange = Object.assign({}, item)
                        // change status of the clone
                        if (toChange.status === "CLOSED") {
                            toChange.status = "OPEN"
                        } else {
                            toChange.status = "CLOSED"
                        }
                        // replace the object by the clone in the backend
                        fetch('/items/' + id, httpOptions("PUT", toChange))
                        .then((res) => {
                            // after the call to the backend was successful, change status in object so it reflects on the page
                            item.status = toChange.status
                        })
                        .catch((err) => console.log(error))
                    },
                    // return true if the item status is closed
                    isClosed: function(item) {
                        return item.status === "CLOSED"
                    },
                    // calculate order based on the old and new indices on item rearrangement
                    // TODO: could be more elegant
                    reOrderItems: function(oldIndex, newIndex) {
                        // dont do anything if the position old and new are equal
                        if (oldIndex == newIndex) {
                            return
                        }
                        // old position can not be smaller or bigger than amount of items
                        if (oldIndex >= this.shoppingItems.length || oldIndex < 0) {
                            console.error("oldIndex out of range")
                            return
                        }
                        // same true for new position
                        if (newIndex >= this.shoppingItems.length || newIndex < 0) {
                            console.error("newIndex out of range")
                            return
                        }
                        // store the result in this object:
                        reorder = {}

                        // move item from smaller to bigger position:
                        if (oldIndex < newIndex) {
                            // loop over all items
                            this.shoppingItems.forEach(function(x, idx) {
                                // item positions outside the moving zone are untpuched
                                if (idx < oldIndex || idx > newIndex) {
                                    reorder[x.id] = idx
                                } 
                                // the item at the old position gets new position:
                                else if(idx == oldIndex) {
                                    reorder[x.id] = newIndex
                                } 
                                // all others are moving up the list one position
                                else if (idx > oldIndex && idx <= newIndex) {
                                    reorder[x.id] = idx - 1
                                }
                            })
                        } 
                        // other way round: item moves from bigger to smaller position:
                        else {
                            // loop over all items
                            this.shoppingItems.forEach(function(x, idx) {
                                // items outside the moving positions stay untouched
                                if (idx < newIndex || idx > oldIndex) {
                                    reorder[x.id] = idx
                                } 
                                // the item at the old position gets new position:
                                else if (idx == oldIndex) {
                                    reorder[x.id] = newIndex
                                } 
                                // all others are moving down the list one position
                                else if (idx >= newIndex && idx < oldIndex) {
                                    reorder[x.id] = idx + 1
                                }
                            })
                        }

                        // now send reorder array to backend:
                        fetch('/items/reorder', httpOptions("POST", reorder))
                        .then((res)  => res.json())
                        .then((json) => {
                            // successful backend request returns a orordered items array, reflect it in page:
                            this.shoppingItems = json.items ? json.items : []
                        })
                        .catch((err) => console.error(err))

                    },
                    getItemId: function(id) {
                        // the drop zone item has a special item id of -1, needs a special html id:
                        if (id == -1) {
                            return "dropzone"
                        }
                        // all others get an html id derived from their item position:
                        return "item_" + this.shoppingItems.findIndex(x => x.id == id)
                    },
                    reorder: function() {
                        var sty_elem, s, i$, to$, i, e, sourceIndex, rule;
                        sty_elem = document.createElement('style');
                        document.head.appendChild(sty_elem)
                      
                        sty_elem.appendChild(document.createTextNode(''))
                        s = sty_elem.sheet
                      
                        for (i= 0; i<= this.shoppingItems.length; i++) {
                          e = i
                          if (this.dragElement != null) {
                            sourceIndex = this.dragElement.$index
                            if (sourceIndex < e) {
                                --e
                            }
                            console.log("reorder: index "+ i+", e: " + e)
                          }
                          rule = '.q div:nth-child(' + (i+1) + ') {top:' + (e*50) + 'px }'
                          s.insertRule(rule, s.cssRules.length)
                        }
                    },
                    dragstart: function(event) {
                        console.log("DRAGSTART")
                        var st;
                        this.dragElement = event.targetVM
                        this._dragNode = event.target

                        this.reorder()
                        st = this._dragNode.style
                        Vue.nextTick(() => {
                          st.opacity = 0
                          st.height = 0
                        })
                        console.log("before insert")
                        //var elem = document.getElementById('listgroup')
                        //elem.insertBefore(this.placeholder, event.target)
                        //console.log("before insert" + elem)
                        this.$el.querySelector('.list-group').insertBefore(this.placeholder, event.target)     

                        //event.dataTransfer.setData("text", event.target.id);
                    },
                    dragend: function(event) {
                        console.log("DRAGEND")
                        console.log(event)
                        this.$el.querySelector('.list-group').removeChild(this.placeholder)
                        this._dragNode.style.opacity = 1
                        this._dragNode.style.height = '50px'
             
                        this._dragNode = null
                        this.dragElement = null
                        
                        this.reorder()
                        event.preventDefault()
                        // add dropzone to list:
                        //this.addDropzone(event.target.id, true)
                        
                    },
/*                    dragleave: function(event) {
                        event.preventDefault()
                        /*var element = document.getElementById("dropzone");
                        if(element) {
                            element.parentNode.removeChild(element);
                        }* /
                        console.log("DRAGLEAVE")
                        console.log(event)

                    },*/
                    dragover: function(event) {
                        event.preventDefault()
                        //event.dataTransfer.dropEffect = 'move'
                        console.log("DRAGOVER")
                        console.log(event)
                        return true
                    },
                    drop: function(event) {
                        event.preventDefault()
                        console.log("DROP")
                        console.log(event)

                        insertIndex = this.insertIndex
                        sourceIndex = this.dragElement.$index
                        if(sourceIndex == insertIndex) {
                            return
                        }
             
                        removed = this.shoppingItems.splice(sourceIndex, 1)
                        this.shoppingItems.splice(insertIndex, 0, removed[0])
                        
                        this.dragend(ev)
                    },
                    dragenter: function(event) {
                        console.log("DRAGENTER")
                        var sourceIndex, insertIndex, posElem;
                        console.log(event)
                        //this.haveDropzone = false

                        sourceIndex = this.dragElement.$index
                        insertIndex = ev.targetVM.$index
                        this.insertIndex = insertIndex
             
                        // FIXME
                        if (sourceIndex < insertIndex) {
                            posElem = event.target
                        } 
                        else {
                            pos.Elem = event.target.previousSibling
                        }
                        
                        document.getElementById('listgroup').insertBefore(this.placeholder, posElem.nextSibling)
                        event.preventDefault()
                        return true
                    },
/*                    addDropzone: function(htmlId, afterElement) {
                        this.haveDropzone = true
                        position = 'beforestart'
                        if (afterElement) {
                            position = 'afterend'
                        }
                        //var that = this
                        // get item id from htmlid:
                        //var id = htmlId.split('_')[1]
                        //var index = this.shoppingItems.findIndex(x => x.id == id)
                        console.log("add dropzone to position " + htmlId)
                        //this.shoppingItems.splice(index, 0, {id: -1, title: "DROPZONE"})
                        /*var element = document.getElementById(htmlId)
                        element.insertAdjacentHTML(position, '<li id="dropzone" class="list-group-item">DROPZONE</li>');
                        //  ondrop="drop" ondragover="dropzone"
                        element.addEventListener('dragover', function (ev) {
                            console.log("DRAGOVER INSIDE")
                            ev.preventDefault()
                        })
                        element.addEventListener('drop', function (ev) {
                            console.log("DROP INSIDE")
                        })
                        * /
                    },
                    removeDropzone: function() {
                        /*var element = document.getElementById("dropzone")
                        if(element) {
                            element.parentNode.removeChild(element);
                        }
                        * /
                        var index = this.shoppingItems.findIndex(x => x.id == -1)
                        this.shoppingItems.splice(index, 1)
                    } */
                },
                // this is the end of the methods definition
                // in this block we define dynamic ("computed") properties
                computed: {
                    /* DEPRECATED
                    sortedList: function() {
                      function compare(a, b) {
                          return a.orderno - b.orderno || a.id - b.id
                      }                  
                      return this.shoppingItems.sort(compare);
                    }
                    */
                  }
            })
        </script>
    </body>
</html>